---
output:
   html_document:
      toc: TRUE
      always_allow_html: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(options(knitr.kable.NA = ''))

```

---
title: "`r report.title`"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
---

# Summary

```{r dataset, results='asis'}
if(!is.null(dataset.name)){
  cat("**Dataset:**", dataset.name)
  cat("\n\n")
}
```
  

**Measure:** `r paste0(measure.name,  " (", item.name.range, ")")`

**Comparison groups:** `r paste(dif.group1, dif.group2, sep = " and ")`

**Items with no variance:** `r no.var.items`

**Items with no variance within levels of comparison variable:** `r no.var.by.group.items`

**DIF detection method:** `r if(bias.method == "IRT") bias.method else paste(bias.method,"using", match.type, "Scores")`

**Total number of biased items:** `r paste(n.biased, "out of", n.items)`

**Type of DIF:** `r dif.type`

```{r direction, results='asis'}
if(dif.type == "uniform"){
  if(n.biased > 0){
  
  cat("* Number of items uniformly biased toward ", dif.group1, ": ", toward[[1]], sep = "")
  cat("\n\n")
  cat("* Number of items uniformly biased toward ", dif.group2, ": ", toward[[2]], sep = "")
  }
}
```
  

```{r No Var, results='asis'}
if(no.var.items != "none"){
  
  cat("\n\n")
  cat("^a^ Items were not included in any DIF analysis and were not used to compute 
      treatment effects.")
  cat("\n\n")
}


if(no.var.by.group.items != "none"){
  
  cat("\n\n")
  cat("^b^ Items were not included in the IRT-based DIF analysis and were not used 
      to compute IRT-based treatment effects.")
  cat("\n\n")
}

```

## Biased Item Summary

```{r bi summary, results = 'asis', ft.align="left"}

if(nrow(bi.table) != 0){
    bi.flex <- format_flex(bi.table)
    cat(knitr::knit_print(bi.flex))
    cat("\n\n")
    cat("&nbsp;  ")
    cat("*Note:* X = method determined item to be biased")
    cat("\n\n")
} else {
    cat("Item bias was not detected by any of the selected methods")
    cat("\n\n")
}

```


# Treatment Effect Robustness

```{r bias.plots, results='asis', message=FALSE, fig.width = 5, fig.height = 6}

gridExtra::grid.arrange(bias.plots[[1]], bias.plots[[2]])

```

```{r Treatment_Effects, results='asis', warning=FALSE, ft.align="left", fig.width = 5, fig.height = 4}

for(i in 1:length(effects.tables)){
  cat("\n\n")
  cat("##", names(effects.tables)[[i]])
  cat("\n\n")
  et.flex <- format_flex(effects.tables[[i]])
  cat(knitr::knit_print(et.flex))
  cat("\n\n")
  cat("&nbsp;  ")
  
  print(effects.plots[[i]])
  
}
```


# DIF Detection Methods

```{r loess, results='asis', warning=FALSE, fig.width = 10, fig.height = ceiling(n.items / 6)*2 + 1}

if(!is.null(dif.analysis$loess)){
  cat("## Graphical Analysis via loess")
  cat("\n\n")
  
  print(dif.analysis$loess$plot)
  
}
```


```{r MH, results='asis', ft.align="left"}

if(!is.null(dif.analysis$MH)){
  
  cat("## Mantel-Haenszel")
  cat("\n\n")
    
  if(class(dif.analysis$MH$item.level) == "character"){
        
    cat(dif.analysis$MH$item.level)
    cat("\n\n")
    
  } else {
    
    MHtab <- format_flex(dif.analysis$MH$item.level, bold.bias = "item")
    cat(knitr::knit_print(MHtab))
    cat("\n\n")
  }
}
```




```{r Logistic Global, results='asis', ft.align="left"}
if(!is.null(dif.analysis$logistic)){
  
  cat("## Logistic Regression")
  cat("\n\n")
  
  cat("#### Model Comparisons")
  cat("\n\n")

  logglobtab <- format_flex(dif.analysis$logistic$global.level, bold.bias = "global")
  cat(knitr::knit_print(logglobtab))
  cat("\n\n")
  
  cat("&nbsp;  ")
  cat("\n\n")
  cat("#### Item-level Tests")
  cat("\n\n")
  
  if(class(dif.analysis$logistic$item.level) == "character"){
    
    cat(dif.analysis$logistic$item.level)
    cat("\n\n")
        
  } else {
    
    logitemtab <- format_flex(dif.analysis$logistic$item.level, bold.bias = "item")
    cat(knitr::knit_print(logitemtab))
    cat("\n\n")
  }

}
```


```{r IRT Global, results='asis', ft.align="left"}

if(!is.null(dif.analysis$IRT)){

  cat("## Item Response Theory")
  cat("\n\n")
  
  cat("#### Model Comparisons")
  cat("\n\n")
  
  irtglobtab <- format_flex(dif.analysis$IRT$global.level, bold.bias = "global")
  cat(knitr::knit_print(irtglobtab))
  cat("\n\n")
 
  cat("&nbsp;  ")
  cat("\n\n")
  cat("#### Item-level Tests")
  cat("\n\n")
  
  if(class(dif.analysis$IRT$item.level) == "character"){
    
    cat(dif.analysis$IRT$item.level)
    cat("\n\n")
        
  } else {
    
    irtitemtab <- format_flex(dif.analysis$IRT$item.level, bold.bias = "item")
    cat(knitr::knit_print(irtitemtab))
    cat("\n\n")
  }
}

```