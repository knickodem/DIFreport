---
author: "PFH & KKN" 
output:
   html_document:
      toc: TRUE
      always_allow_html: TRUE
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(options(knitr.kable.NA = ''))


library(knitr)
library(rmarkdown)
library(flextable)

```

---
title: "`r paste0("Measurement Bias Analysis of ", Measure_Name, " by ", Comparison_Name, " in ", Dataset_Name)`"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
---

# Summary


**Dataset:** `r Dataset_Name`

**Outcome variable:** `r paste0(Measure_Name,  " (", item_name_range, ")")`

**Comparison variable:** `r paste0(Comparison_Name, " (", comparison_levs, ")")`

**Items with no variance:** `r nvi`

**Items with no variance within levels of comparison variable:** `r nvgi`

**Bias detection method:** `r if(bias_method == "IRT") bias_method else paste(bias_method, "using", DIF_Results$Inputs$scoreType, "Scores")`

**Total number of biased items:** `r paste(n_biased, "out of", n_items)`

**Type of item bias:** `r bias_type`

```{r direction, results='asis'}
if(bias_method == "MH"){
  if(!is.null(BIs)){
  
  cat("* Number of items uniformly biased toward " ,comp1,": ", toward1, sep = "")
  cat("\n\n")
  cat("* Number of items uniformly biased toward " ,comp2,": ", toward2, sep = "")
  }
}
```
  

```{r No Var, results='asis'}
if(nvi != "none"){
  
  cat("\n\n")
  cat("^a^ Items were not included in any DIF analysis and were not used to compute IRT-based robustness checks of treatment effects.")
  cat("\n\n")
}


if(nvgi != "none"){
  
  cat("\n\n")
  cat("^b^ Items were not included in the IRT-based DIF analysis and were not used to compute IRT-based robustness checks of treatment effects.")
  cat("\n\n")
}

```



```{r Summary Table, results='asis'}

if(!is.null(BIs)){
    
  if(is.null(conditional)){
    
    cat("## Robustness Checks for Treatment Effects")
    cat("\n\n")
    
    cat("Summary table for robustness of unconditional treatment effects (comparing ", UnconditionalEffects$Comparison, ")", sep  ="") 
    cat("\n\n")
    
    unctab <- Get_Flex(UnconditionalEffects$Effects_Table)
    cat(knit_print(unctab))
    cat("\n\n")
    
  } else {
  
    cat("## Robustness Checks for Treatment Effects Conditional on Comparison Variable")
    cat("\n\n")
  
    cat("Summary table for robustness of conditional treatment effects for ", comp1, " (comparing ", ConditionalEffects1$Comparison, ")", sep  = "") 
    cat("\n\n")
  
    condeff1tab <- Get_Flex(ConditionalEffects1$Effects_Table)
    cat(knit_print(condeff1tab))
    cat("\n\n")
  
    cat("&nbsp;  ")
    cat("\n\n")
    cat("Summary table for robustness of conditional treatment effects for ", comp2, " (comparing ", ConditionalEffects2$Comparison, ")", sep  = "") 
    cat("\n\n")
    
    condeff2tab <- Get_Flex(ConditionalEffects2$Effects_Table)
    cat(knit_print(condeff2tab))
    cat("\n\n")
    
    cat("&nbsp;  ")
    cat("\n\n")
    cat("Interaction of treatment effect by ", Comparison_Name, " (", comp1, " - ", comp2, ")", sep = "")
    cat("\n\n")
    inttab <- Get_Flex(InteractionEffects)
    cat(knit_print(inttab))
    cat("\n\n")
  }
  
  cat("&nbsp;  ")
  cat("*Note:* Adj. Delta  = Scale Delta / sqrt(Reliability)")
  
} else {
  
    cat("\n\n")
    cat(NoDIFmessage)
    cat("\n\n")
}

```


# Bias Detection Methods

```{r loess, results='asis', fig.width = 10, fig.height = ceiling(n_items / 6)*2 + 1}

if(!is.null(DIF_Results$loess)){
  cat("## Graphical Analysis via Loess")
  cat("\n\n")
  
  print(DIF_Results$loess$plot)
  
}
```




```{r MH, results='asis'}

if(!is.null(DIF_Results$MH)){
  
  cat("## Mantel-Haenszel")
  cat("\n\n")
    
  if(class(DIF_Results$MH$Item) == "character"){
        
    cat(DIF_Results$MH$Item)
    cat("\n\n")
    
  } else {
    
    MHtab <- Get_Flex(DIF_Results$MH$Item, boldbias = "item")
    cat(knit_print(MHtab))
    cat("\n\n")
  }
}
```




```{r Logistic Global, results='asis'}
if(!is.null(DIF_Results$logistic)){
  
  cat("## Logistic Regression")
  cat("\n\n")
  
  cat("#### Model Comparisons")
  cat("\n\n")

  logglobtab <- Get_Flex(DIF_Results$logistic$Global, boldbias = "global")
  cat(knit_print(logglobtab))
  cat("\n\n")
  
  cat("&nbsp;  ")
  cat("\n\n")
  cat("#### Item-level Tests")
  cat("\n\n")
  
  if(class(DIF_Results$logistic$Item) == "character"){
    
    cat(DIF_Results$logistic$Item)
    cat("\n\n")
        
  } else {
    
    logitemtab <- Get_Flex(DIF_Results$logistic$Item, boldbias = "item")
    cat(knit_print(logitemtab))
    cat("\n\n")
  }

}
```


```{r IRT Global, results='asis'}

if(!is.null(DIF_Results$IRT)){

  cat("## Item Response Theory")
  cat("\n\n")
  
  cat("#### Model Comparisons")
  cat("\n\n")
  
  irtglobtab <- Get_Flex(DIF_Results$IRT$Global, boldbias = "global")
  cat(knit_print(irtglobtab))
  cat("\n\n")
 
  cat("&nbsp;  ")
  cat("\n\n")
  cat("#### Item-level Tests")
  cat("\n\n")
  
  if(class(DIF_Results$IRT$Item) == "character"){
    
    cat(DIF_Results$IRT$Item)
    cat("\n\n")
        
  } else {
    
    irtitemtab <- Get_Flex(DIF_Results$IRT$Item, boldbias = "item")
    cat(knit_print(irtitemtab))
    cat("\n\n")
  }
}

```